name: Deploy MOVE

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: SSH 접속 및 move 프로젝트 배포
        uses: appleboy/ssh-action@v1.0.0
        with:
          port: 22
          host: ${{ secrets.SERVER_HOST }}
          key: ${{ secrets.SERVER_KEY }}
          username: ${{ secrets.SERVER_USER }}
          script: |
            # 1. 최신 코드 강제 반영 (move 프로젝트)
            cd move
            git fetch --all
            git reset --hard origin/main
            git clean -fdx   # 추적 안되는 파일/폴더 제거

            # 2. 기존 컨테이너 종료 (볼륨 보존)
            docker compose down --remove-orphans

            # 3. backend JAR 강제 새 빌드
            cd backend
            chmod +x ./gradlew
            ./gradlew clean bootJar -x test
            ls -la build/libs/  # JAR 제대로 생성됐는지 확인
            cp build/libs/*.jar ../backend.jar
            cd ..

            # 4. frontend 빌드 (dist 생성 → Caddy 서빙)
            cd frontend
            npm install
            npm run build
            cd ..

            # 5. backend + db 컨테이너만 실행한다. (프론트엔드는 Caddy가 알아서 서빙합니다)
            docker compose up -d --build
