name: Deploy MOVE

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: SSH 접속 및 move 프로젝트 배포
        uses: appleboy/ssh-action@v1.0.0
        with:
          port: 22
          host: ${{ secrets.SERVER_HOST }}
          key: ${{ secrets.SERVER_KEY }}
          username: ${{ secrets.SERVER_USER }}
          script: |
            # 1. 최신 코드 강제 반영 (move 프로젝트)
            cd move
            git fetch --all
            git reset --hard origin/main
            git clean -fdx   # 추적 안되는 파일/폴더 제거

            # 2. 기존 컨테이너 종료 (볼륨 보존)
            docker compose down --remove-orphans

            # 3. backend JAR 강제 새 빌드
            cd backend
            chmod +x ./gradlew
            ./gradlew clean bootJar -x test
            ls -la build/libs/  # JAR 제대로 생성됐는지 확인
            cp build/libs/*.jar ../backend.jar
            cd ..

            # 4. frontend 빌드 준비 
            cd frontend
            cat > .env <<'EOL'
            VITE_WS_URL=https://move.io.kr/ws
            VITE_IO_URL=https://move.io.kr/backend
            VITE_STOMP_URL=https://move.io.kr/ws
            VITE_STOMP_USER=guest
            VITE_STOMP_PASS=guest
            VITE_GPS_TOPIC=/move/gps
            VITE_KAKAO_MAP_APP_KEY=${{ secrets.VITE_KAKAO_MAP_APP_KEY }}
            EOL

            
            # 서비스 전부 실행
            docker compose up -d --build

            # Caddy가 프로젝트를 인식하도록 네트워크 연결
            docker network connect gwon_default gwon-caddy-1 || true
            docker network connect geon_default gwon-caddy-1 || true
            docker network connect move_default gwon-caddy-1 || true


            